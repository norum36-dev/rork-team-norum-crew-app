workflows:
  android-release-apk:
    name: Android Release APK
    max_build_duration: 60
    environment:
      vars:
        # Ikke bruk nvm; Codemagic-bildet har allerede Node
        # Vi lar Corepack styre Yarn om yarn.lock finnes
        CI: "true"
    scripts:
      - name: Installer avhengigheter (auto-detect Yarn/NPM)
        script: |
          if [ -f yarn.lock ]; then
            echo "Detected yarn.lock → using Yarn"
            corepack enable
            corepack prepare yarn@stable --activate
            yarn install --frozen-lockfile
            export PKG_MGR="yarn"
          elif [ -f package-lock.json ]; then
            echo "Detected package-lock.json → using NPM (ci)"
            npm ci
            export PKG_MGR="npm"
          else
            echo "No lockfile found → fallback to NPM install"
            npm install
            export PKG_MGR="npm"
          fi
          echo "Package manager: $PKG_MGR"

      - name: Generer native Android-prosjekt (expo prebuild)
        script: |
          npx expo prebuild --platform android --non-interactive --no-install

      - name: Gjenopprett keystore fra base64
        script: |
          echo "Restoring keystore to android/app/upload-keystore.jks"
          mkdir -p $CM_BUILD_DIR/android/app
          echo $CM_KEYSTORE | base64 --decode > $CM_BUILD_DIR/android/app/upload-keystore.jks
          ls -la $CM_BUILD_DIR/android/app

      - name: Legg til signing-properties til Gradle
        script: |
          cat >> $CM_BUILD_DIR/android/gradle.properties <<EOF
          MYAPP_UPLOAD_STORE_FILE=upload-keystore.jks
          MYAPP_UPLOAD_KEY_ALIAS=$CM_KEY_ALIAS
          MYAPP_UPLOAD_STORE_PASSWORD=$CM_KEYSTORE_PASSWORD
          MYAPP_UPLOAD_KEY_PASSWORD=$CM_KEY_PASSWORD
          EOF
          echo "Signing properties appended to android/gradle.properties"
          # Masker passord i logg
          sed -E 's/(PASSWORD=).+/\1[HIDDEN]/g' $CM_BUILD_DIR/android/gradle.properties || true

      - name: Bygg signert Release APK
        script: |
          cd android
          chmod +x ./gradlew
          ./gradlew clean
          ./gradlew :app:assembleRelease --stacktrace

    artifacts:
      - android/app/build/outputs/apk/release/app-release.apk
